<!DOCTYPE html>
<html>
    <head>
      <style>
  div.scrollmenu {
      background-color: #333;
      overflow: auto;
      white-space: nowrap;
  }

  div.scrollmenu a {
      display: inline-block;
      color: white;
      text-align: center;
      padding: 14px;
      text-decoration: none;
  }

  div.scrollmenu a:hover {
      background-color: #777;
  }
  #photo_stripe{
    width: 30em;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
  }

  #tagdiv_marker input:not([type]):focus:not([readonly]), #tagdiv_marker input[type=text]:focus:not([readonly]), #tagdiv_marker input[type=password]:focus:not([readonly]), #tagdiv_marker input[type=email]:focus:not([readonly]), #tagdiv_marker input[type=url]:focus:not([readonly]), #tagdiv_marker input[type=time]:focus:not([readonly]), #tagdiv_marker input[type=date]:focus:not([readonly]), #tagdiv_marker input[type=datetime]:focus:not([readonly]), #tagdiv_marker input[type=datetime-local]:focus:not([readonly]), #tagdiv_marker input[type=tel]:focus:not([readonly]), #tagdiv_marker input[type=number]:focus:not([readonly]), #tagdiv_marker input[type=search]:focus:not([readonly]), #tagdiv_marker textarea.materialize-textarea:focus:not([readonly]){
    box-shadow: none !important;
  }

  #tagdiv_marker input:not([type]), #tagdiv_marker input[type=text], #tagdiv_marker input[type=password], #tagdiv_marker input[type=email], #tagdiv_marker input[type=url], #tagdiv_marker input[type=time], #tagdiv_marker input[type=date], #tagdiv_marker input[type=datetime], #tagdiv_marker input[type=datetime-local], #tagdiv_marker input[type=tel], #tagdiv_marker input[type=number], #tagdiv_marker input[type=search], #tagdiv_marker textarea.materialize-textarea {
    height: auto !important;
  }

  .myButton {
    -moz-box-shadow:inset 0px 0px 15px 3px #23395e;
    -webkit-box-shadow:inset 0px 0px 15px 3px #23395e;
    box-shadow:inset 0px 0px 15px 3px #23395e;
    background-color:#2e466e;
    -moz-border-radius:17px;
    -webkit-border-radius:17px;
    border-radius:17px;
    border:1px solid #1f2f47;
    display:inline-block;
    cursor:pointer;
    color:#ffffff;
    font-family:Arial;
    font-size:15px;
    padding:9px 24px;
    text-decoration:none;
    text-shadow:0px 1px 0px #263666;
  }
  .myButton:hover {
    background-color:#415989;
  }
  .myButton:active {
    position:relative;
    top:1px;
  }

  .left_b {
    max-width: 100%;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    -ms-text-overflow:ellipsis;
    float: left;
    }
    .right_b {
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
        -ms-text-overflow:ellipsis;
        /*text-align: right;*/
    }
  </style>

    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width" />
    <meta property="og:image" content="route.png" />
    <title>ethPhoto</title>
   
   <!--  <link rel="stylesheet" type="text/css" href="css/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="css/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="css/Leaflet.Photo.css" />
    <link rel="stylesheet" type="text/css" href="css/materialize.min.css"  media="screen,projection"/>
 -->    
 <!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->

<!--     <link rel="stylesheet" type="text/css" href="css/custom_map.css" />
    <link rel="stylesheet" type="text/css" href="css/custom_main.css">
    <link rel="stylesheet" type="text/css" href="css/custom_stripe.css">
 -->
    <!-- <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"> -->
    <link rel="stylesheet" href="css/app.css">
    <script src="js/app.js"></script>
  </head>

  <body>
    <!-- search Box -->
    <div id="searchBox" class="z-depth-1">
       <!--  <div class="left_b" id="searchType">
          <div class="input-field z-depth-1" >
            <select id='searchTypeSelect'>  
              <option value="1" selected="selected">Location</option>
              <option value="2">Image</option>
            </select>
          </div>
        </div> -->

        <input type="search" placeholder="  Search ethPhoto..." name="searchLocation" class="searchBox autocomplete right_b" id="autocomplete-input">
        <div id="loc_info">
        	<div class="row">
        	<a id="closebtn" href="#" onclick="$('#loc_info').css('display','none'); ">Ã—</a>
		    <form class="col s12" style="margin-top: 10px;">
		      <div class="row">
		        <div class="input-field col s6">
		        	<span style="font-size: 19px;"><b>Latitude:</b></span>
		        	<span style="font-size: 17px;" id="latinfo"></span>
		        </div>
		        <div class="input-field col s6">
			        <span style="font-size: 19px;"><b>Longitude:</b></span>
			        <span style="font-size: 17px;" id="longinfo"></span>
		        </div>
		      </div>
		      <div class="row">
		      	<div class="col s12 file-field input-field">
		        	<div class="myButton left_b"><span><!-- <i class="large material-icons">backup</i> -->Upload</span><input type="file" id = "upload"></div>
		        	<div class="file-path-wrapper right_b"><input class="file-path validate" id="upload_text" type="text"></div>
		        	<!-- <div class="chips chips-autocomplete"></div> -->
        		</div>
		      </div>
		      <div class="row">
		      	<div class="input-field col s8" id = "tagdiv_marker">
              <!-- <input id="tag" type="text" class="validate"><label for="tag">Tag</label> -->
              <input type="text" id="tag" class="right_b" />
	        	</div>
	        	<div class="col s3 offset-s1">
	        		<a class="myButton" id = "add_image">Done</a>
	        	</div>
		      </div>
		    </form>
		  </div>
        </div>
        <a class="btn white searchBtn tooltipped right" data-position="bottom" data-delay="50" data-tooltip="Search">
          <div class="preloader-wrapper small hide">
            <div class="spinner-layer spinner-green-only">
              <div class="circle-clipper left">
                <div class="circle"></div>
              </div><div class="gap-patch">
                <div class="circle"></div>
              </div><div class="circle-clipper right">
                <div class="circle"></div>
              </div>
            </div>
          </div>
          <i class="material-icons left black-text">search</i>
          </a>
    </div>

    <div id="searchType">
      <div class="input-field z-depth-1" >
        <select id='searchTypeSelect'>
          <option value="1">  Location Search</option>
          <option value="2">  Image Search</option>
        </select>
        <label>Search Type</label>
      </div>
    </div>

    <div id="searchTags" style="display:none;">
      <div class="input-field z-depth-1" >
        <select id='tagSelect' multiple>
          <option value="None" selected disabled>  None</option>
        </select>
        <label>Select Tags</label>
      </div>
    </div>
    <!-- <div id="slider-vertical" style="height:200px; z-index: 10000;">safasf</div> -->

    <div id="photoViewer">
      <div class="row">
          <div class="card">
            <div class="card-image">
              <img id="viewer" />
              <span class="card-title" style="display:none;">Tags</span>
              <a id="delete_pic" class="btn-floating halfway-fab waves-effect waves-light red" style="display:none;"><i class="material-icons">delete</i></a>
            </div>
            <div class="card-content">
              <p>Please wait while the images get loaded...</p>
            </div>
          </div>
      </div>
    </div>
    <div id="photoViewer1" style="display: none;">
      <div class="row">
          <div class="card" id="pv1card">
            <!-- <div class="card-image">
              <img id="viewer" />
              <span class="card-title" style="display:none;">Tags</span>
              <a id="delete_pic" class="btn-floating halfway-fab waves-effect waves-light red" style="display:none;"><i class="material-icons">delete</i></a>
            </div> -->
            <div class="card-image" id="pv1cardimage">
              <!-- <p>Please wait while the images get loaded...</p> -->
            </div>
          </div>
      </div>
    </div>
    <div id="trigger_stripe"><i class="material-icons small tooltipped" data-tooltip="Show my photos" id="trigger_stripe" >perm_media</i></div>
    <div id="photo_stripe">
<!--       <img class="photo_box" src="images/photo1.jpg">
      <img class="photo_box" src="images/photo2.jpg">
      <img class="photo_box" src="images/photo3.jpg">
      <img class="photo_box" src="images/photo6.jpg">
      <img class="photo_box" src="images/photo4.jpg">
      <img class="photo_box" src="images/photo6.jpg">
      <img class="photo_box" src="images/photo4.jpg">
      <img class="photo_box" src="images/photo1.jpg">
      <img class="photo_box" src="images/photo6.jpg">
      <img class="photo_box" src="images/photo4.jpg">
      <img class="photo_box" src="images/photo6.jpg">
      <img class="photo_box" src="images/photo4.jpg">
      <img class="photo_box" src="images/photo1.jpg"> -->
    </div>
    <!-- The map -->
    <div id="map"></div>


  <!-- <ul id="slide-out" class="side-nav" style="z-index: 10000">
    <div class="row">
        <div class="col s12">
          <a>Add a new photo</a>
        </div>
        <div class="col s12 file-field input-field">
          <div class="btn">
            <span>File</span><br/>
            <input type="file" id="upload">
          </div>
          <div class="file-path-wrapper">
            <input class="file-path validate" type="text">
          </div>
        </div>
        <div class="input-field col s12" id = "tagdiv" style="display: none;">
          <input id="tag" type="text" class="validate">
          <label for="tag">Tag</label>
        </div>
        <div class="col s6">
          <a class="waves-effect waves-light btn" id = "add_tag" style="display: none;">Tag</a>
        </div>
        <div class="col s6">
          <a class="waves-effect waves-light btn-large" id = "add_image" style="display: none;">Done</a>
        </div>
    </div>
  </ul> -->
  <!-- <div class="fixed-action-btn" style="z-index: 0">
  <a href="#" id="current_location_btn" class="btn-floating btn tooltipped" data-position="left" data-delay="50" data-tooltip="Go to current location" style="background-color: red ; margin-bottom: 70px; margin-right: 9px;"><i class="material-icons z-depth-2">location_searching</i></a>
  </div> -->
  <div class="fixed-action-btn">
  <a href="#" id="cornerbtn" class="btn-floating btn-large tooltipped" data-position="left" data-delay="50" data-tooltip="Add Photos" style="background-color:#207ac9;"><i class="material-icons z-depth-2">add</i></a>
  </div>
  <output id="list"></output>

  <!-- <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
  <script type="text/javascript" src="js/materialize.min.js"></script>
  <script type="text/javascript" src="js/reqwest.min.js"></script>
  <script type="text/javascript" src="js/leaflet.js"></script>
  <script type="text/javascript" src="js/leaflet.markercluster.js"></script>
  <script type="text/javascript" src="js/Leaflet.Photo.js"></script>
  <script type="text/javascript" src="js/exif.js"></script>
  <script type="text/javascript" src="js/index.js"></script>
  <script type="text/javascript" src="js/photo-stripe.js"></script> 
  <script src="http://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
  <script type="text/javascript">
  // $( "#slider-vertical" ).slider({
  //     orientation: "vertical",
  //     range: "min",
  //     min: 0,
  //     max: 100,
  //     value: 60,
  //     slide: function( event, ui ) {
  //       // alert(ui.value);
  //     }
  //   });

  L.Icon.Default.imagePath = 'images/';

  var search_handler_calls = 0;
  var map = null;
  var photoLayer;
  var onClickMarker = "";
  var lat = 22.31, long_ = 87.31;
  var tagSet;
$(document).ready(function () {
    function getTags() {
      tagSet = [{id: "Abstract", name: "Abstract"},
                  {id: "Aerial", name: "Aerial"},
                  {id: "Animal", name: "Animal"},
                  {id: "Architecture", name: "Architecture"},
                  {id: "Astrophotography", name: "Astrophotography"},
                  {id: "Avian", name: "Avian"},
                  {id: "Black and White", name: "Black and White"},
                  {id: "Cityscape", name: "Cityscape"},
                  {id: "Current Events", name: "Current Events"},
                  {id: "Decisive Moment", name: "Decisive Moment"},
                  {id: "Defocused", name: "Defocused"},
                  {id: "Documentary", name: "Documentary"},
                  {id: "Emotive", name: "Emotive"},
                  {id: "Expression", name: "Expression"},
                  {id: "Family", name: "Family"},
                  {id: "Fashion", name: "Fashion"},
                  {id: "Film", name: "Film"},
                  {id: "Fine Art", name: "Fine Art"},
                  {id: "Food", name: "Food"},
                  {id: "Glamour", name: "Glamour"},
                  {id: "HDRI (High Dynamic Range Imaging)", name: "HDRI (High Dynamic Range Imaging)"},
                  {id: "Humorous", name: "Humorous"},
                  {id: "ICM (intentional camera movement)", name: "ICM (intentional camera movement)"},
                  {id: "Industrial", name: "Industrial"},
                  {id: "Infrared", name: "Infrared"},
                  {id: "Interior", name: "Interior"},
                  {id: "Journalism", name: "Journalism"},
                  {id: "Landscape", name: "Landscape"},
                  {id: "Lomo", name: "Lomo"},
                  {id: "Macro", name: "Macro"},
                  {id: "Nature", name: "Nature"},
                  {id: "Nude", name: "Nude"},
                  {id: "Panoramas/Mosaics", name: "Panoramas/Mosaics"},
                  {id: "Performance", name: "Performance"},
                  {id: "Pinhole", name: "Pinhole"},
                  {id: "Portrait", name: "Portrait"},
                  {id: "Product", name: "Product"},
                  {id: "Publicity", name: "Publicity"},
                  {id: "Random", name: "Random"},
                  {id: "Recycled Art", name: "Recycled Art"},
                  {id: "Rough Camera", name: "Rough Camera"},
                  {id: "Rural", name: "Rural"},
                  {id: "Sea and Sand", name: "Sea and Sand"},
                  {id: "Sky", name: "Sky"},
                  {id: "Snapshot", name: "Snapshot"},
                  {id: "Sports", name: "Sports"},
                  {id: "Still Life", name: "Still Life"},
                  {id: "Stock", name: "Stock"},
                  {id: "Street Photography", name: "Street Photography"},
                  {id: "Suburban", name: "Suburban"},
                  {id: "Swimsuit", name: "Swimsuit"},
                  {id: "Tourist", name: "Tourist"},
                  {id: "Travel", name: "Travel"},
                  {id: "Underwater", name: "Underwater"},
                  {id: "Urban", name: "Urban"},
                  {id: "Vehicle", name: "Vehicle"},
                  {id: "Vintage", name: "Vintage"},
                  {id: "Weather", name: "Weather"},
                  {id: "Wedding", name: "Wedding"}];
                  for (var i = 0; i< tagSet.length; i++){
                    $('#tagSelect').append('<option value="'+tagSet[i].name+'">  '+tagSet[i].name+'</option>')
                  }
                  $('select').material_select();
    }


    function onMapClick(e) {
      if(onClickMarker != ""){
          map.removeLayer(onClickMarker);
      }
      var latitude = e.latlng["lat"];
      var longitude = e.latlng["lng"];
      lat = latitude;
      long_ = longitude;
      $("#latinfo").html(latitude.toFixed(2));
      $("#longinfo").html(longitude.toFixed(2));
      // $('#loc_info').css('display','block');
      onClickMarker = L.marker([latitude, longitude]).addTo(map);
    }

    function getHashFromUrl(url){
      return url.split('/').slice(-1)[0];
    }

    function getUrlFromHash(hash){
      return "http://localhost:8080/ipfs/"+hash;
    }

    function refreshLayer(){
      if(map){
        map.removeLayer(photoLayer);
        map.remove();
      }

      map = L.map('map', {
        maxZoom: 14
      });

      var southWest = L.latLng(-89.98155760646617, -180),
      northEast = L.latLng(89.99346179538875, 180);
      var bounds = L.latLngBounds(southWest, northEast);
      map.setMaxBounds(bounds);
      map.on('drag', function() {
        map.panInsideBounds(bounds, { animate: false });
      });
      map.on('click', onMapClick);

      L.tileLayer('http://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        id: 'mapbox.streets',
        minZoom:3, 
        maxZoom: 15,
        subdomains:['mt0','mt1','mt2','mt3'],
        noWrap: true,
      }).addTo(map);
      delete photoLayer;

      photoLayer = L.photo.cluster().on('click', function (evt) {
        var photo = evt.layer.photo;
        var template = '<img src="{url}"/></a><p style="width:100%; text-align:center;">{caption}</p>';

        evt.layer.bindPopup(L.Util.template(template, photo), {
          className: 'leaflet-popup-photo',
          minWidth: 300
          }).openPopup();
        });
      photoLayer.add(allPhotos).addTo(map);
      map.fitBounds(photoLayer.getBounds());
    }

    function init(){
      

      var str = SimpleStorage.GetImages();
      // console.log(str);
      str.then(function(result) {
      var arr = result.toString().split("\n");

      console.log(arr);

      delete allPhotos;
      allPhotos = [];
      for (i = 0; i < arr.length - 1; i++){
             var temp = arr[i].split(";");
             // Images[i] = {ImageUrl:getUrlFromHash(temp[0]), Latitude:temp[1], Longitude:temp[2], Tags:temp[3]};
             allPhotos[i] = {"url":getUrlFromHash(temp[0]), "lat":temp[1], "lng":temp[2], "caption":temp[3], "video":"", "thumbnail":getUrlFromHash(temp[0])};
         }
      console.log(allPhotos); 

      if(allPhotos.length == 0){
        allPhotos.push({
          "lat":59.2606475,
          "lng":5.8837028,
          "thumbnail":"http://localhost:8080/ipfs/QmXxC4ae22EbK5d8sycZC4q9BcWU4rz5W8UbBMYV3yjJuH",
          "url":"http://localhost:8080/ipfs/QmXxC4ae22EbK5d8sycZC4q9BcWU4rz5W8UbBMYV3yjJuH",
          "video":"",
          "caption":"Denali"});

        allPhotos.push({
          "lat":70.2606475,
          "lng":7.8837028,
          "thumbnail":"http://localhost:8080/ipfs/QmWoBr1YFKkA5D4jCNramLHoZQKXet1DhrxBGGxo66Gnz7",
          "url":"http://localhost:8080/ipfs/QmWoBr1YFKkA5D4jCNramLHoZQKXet1DhrxBGGxo66Gnz7",
          "video":"",
          "caption":"Alberta"});
      }
      /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      // Refresh the Photos layer here.
      /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      refreshLayer();
      getTags();

        $("#tag").tokenInput(tagSet, {
            theme: "facebook"
        });
      });

    }
    init();

    $("#add_image").click(function() {
      // console.log("clicked!");
      var input = $("#upload");
      var long_= $('#longinfo').text();
      var lat = $('#latinfo').text();
      var caption_ =  $('#tag').val();
      // console.log(document.getElementById("upload_text").value+"~~~~");
      // console.log(caption_+"***");
      if(caption_ == "" || document.getElementById("upload_text").value==""){
        console.log("empty");
        alert("Please fill in all fields");
        return;
      }
      EmbarkJS.Storage.uploadFile(input).then(function(hash) {
        myImages.push({"url":getUrlFromHash(hash), "lat":lat, "lng":long_, "caption":caption_, "video":"", "thumbnail":getUrlFromHash(hash)});
        SimpleStorage.upload(hash, String(lat), String(long_), String(caption_)).then(function () {
          console.log(hash); 
          var str = SimpleStorage.GetImages();
          // console.log(str);
          str.then(function(result) {
          var arr = result.toString().split("\n");

          console.log(arr);

          delete allPhotos;
          allPhotos = [];
          for (i = 0; i < arr.length - 1; i++){
                 var temp = arr[i].split(";");
                 // Images[i] = {ImageUrl:getUrlFromHash(temp[0]), Latitude:temp[1], Longitude:temp[2], Tags:temp[3]};
                 allPhotos[i] = {"url":getUrlFromHash(temp[0]), "lat":temp[1], "lng":temp[2], "caption":temp[3], "video":"", "thumbnail":getUrlFromHash(temp[0])};
             }
          console.log(allPhotos); 
          /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
          // Refresh the Photos layer here.
          /////////////////////////////////////////////////////////////////////////////////////////////////////////////////
          $("#loc_info").css('display', 'none');
          document.getElementById("upload").value = "";
          document.getElementById("upload_text").value = "";
          $("#tagdiv_marker").val();
          refreshLayer();
          });
        });
      });
    });

    $("#trigger_stripe").click(function() {
      if(myImages.length == 0){
            var str = SimpleStorage.GetUserImages();
            // console.log(str);
            str.then(function(result) {
            var arr = result.toString().split("\n");
              
              console.log("IN trigger!");
              console.log(arr);

              myImages = [];
              for (i = 0; i < arr.length; i++){
                   var temp = arr[i].split(";");
                   myImages.push({"url":getUrlFromHash(temp[0]), "lat":temp[1], "lng":temp[2], "caption":temp[3], "video":"", "thumbnail":getUrlFromHash(temp[0])});
               }
              console.log(myImages); 
              $("#photo_stripe").html('');
              $('#viewer').attr('src', '');
              $('#photoViewer .card-title').css('display', 'none');
              $('#photoViewer a').css('display', 'none');
              
              if (myImages.length == 0 || (myImages.length==1 && !myImages[0].lat)){
                $('#photoViewer .card-content').html('<p>You do not have any personal images to show.</p>');
              }
              else {
                for (i = 0; i < myImages.length; i++){
                  if(myImages[i].lat){
                    $("#photo_stripe").append('<img class="photo_box" src="'+myImages[i].url+'" caption="'+myImages[i].caption+'">');
                  }
                }
                $('#photoViewer .card-content').html('<p>Please click on any of the below images to start exploring!</p>');
              }
              trigger_stripe();  
            });
      }
      else {
        $("#photo_stripe").html('');
        $('#viewer').attr('src', '');
        $('#photoViewer .card-title').css('display', 'none');
        $('#photoViewer a').css('display', 'none');

        if (myImages.length == 0 || (myImages.length==1 && !myImages[0].lat)){
          $('#photoViewer .card-content').html('<p>You do not have any personal images to show.</p>');
        }
        else {
          for (i = 0; i < myImages.length; i++){
            if(myImages[i].lat){
              $("#photo_stripe").append('<img class="photo_box" src="'+myImages[i].url+'" caption="'+myImages[i].caption+'">');
            }
          }
          $('#photoViewer .card-content').html('<p>Please click on any of the below images to start exploring!</p>');
        }
        trigger_stripe();  
      }
      
    });

    function searchQuery(finalLocationValue){
        if(finalLocationValue == ""){
            alert("Enter a Location First");
        } else{
            $.ajax({
                url:"http://photon.komoot.de/api/?q="+finalLocationValue,
                type:"GET",
                cache: false,
                error: function() {
                    alert("an error occured");
                },
                success: function(response){
                    if(response!='error'){
                        if (response["features"].length == 0) {
                            alert("Location searched not found");
                            return;
                        }
                        long_ = response["features"][0]["geometry"]["coordinates"][0];
                        lat = response["features"][0]["geometry"]["coordinates"][1];
                        map.setView(new L.LatLng(lat, long_), 12);

                    }
                }
            });
        }

    }

    function autoComplete(dataObj){
        // console.log("here");
        // console.log(dataObj);
        $('input.autocomplete').autocomplete({
            data: dataObj,
            limit: 5
        });
            //
        $('.searchBox').keyup();
        $('.autocomplete-content li').bind("click",function(e){
            // var search_type = $('#searchTypeSelect').val();
            // if (search_type == 1){
            searchQuery($(".searchBox").val());
            // }
            // else if (search_type == 2){
            //   var tags = $('#tagSelect').val();
            //   ImageSearch(lat, long, tags);
            // }
        });   
        $(".preloader-wrapper").removeClass("active");
        $(".searchBtn i").removeClass("hide");
        $(".searchBtn").removeClass("disabled");
        $(".preloader-wrapper").addClass("hide");
    }

    $(document).on("click", ".searchBtn", function(){
        var search_type = $('#searchTypeSelect').val();
        if (search_type == 1){
          searchQuery($(".searchBox").val());
        }
        else if (search_type == 2){
          var tags = $('#tagSelect').val();
          ImageSearch(lat, long_, tags);
        }
    });

    $("#map").on("click", function(){
      $(".leaflet-popup-content > img").on("click",function(e){
          console.log($(this).attr('src'));
          console.log("sdfgsdgsag");
          // $('#photoViewer').toggle(300);
          var img_temp_src = $(this).attr('src');
          // $("#photo_stripe").css('display','none');
          // $('#viewer').attr('src', img_temp_src);
          $('#photoViewer1').css('display','block');
          // $('#photoViewer .card-title').css('display', 'block');
          // $('#photoViewer a').css('display', 'block');

          // $('#photoViewer .card-content').html('<p>You do not have any personal images to show.</p>');
          $('#photoViewer1 .card-image').html('<img src='+img_temp_src+'/>');
          // $("#photo_stripe").css('display','none');
          // $("#photo_stripe").append('<img class="photo_box" src="'+img_temp_src+'">');
          
          // if (myImages.length == 0 || (myImages.length==1 && !myImages[0].lat)){
          //   $('#photoViewer .card-content').html('<p>You do not have any personal images to show.</p>');
          // }
          // else {
          //   for (i = 0; i < myImages.length; i++){
          //     if(myImages[i].lat){
          //       $("#photo_stripe").append('<img class="photo_box" src="'+myImages[i].url+'" caption="'+myImages[i].caption+'">');
          //     }
          //   }
          //   $('#photoViewer .card-content').html('<p>Please click on any of the below images to start exploring!</p>');
          // }
      });
    });
    
    $(document).on('click','#photoViewer1',function(){
      $('#photoViewer1').css('display','none'); 
    });

    $('.searchBox').bind("enterKey",function(e){
        var search_type = $('#searchTypeSelect').val();
        if (search_type == 1){
          searchQuery($(".searchBox").val());
        }
        else if (search_type == 2){
          var tags = $('#tagSelect').val();
          ImageSearch(lat, long, tags);
        }
    });
    
    $('.searchBox').keyup(function(e){
      $("#loc_info").css('display', 'none');
      search_handler_calls++;
      if(e.keyCode == 37 || e.keyCode == 38 || e.keyCode == 39 || e.keyCode == 40){
          return false;
      }
      else if(e.keyCode == 13 )
      {
          $(this).trigger("enterKey");
      } else{
          if (search_handler_calls >= 2) {
              // console.log(search_handler_calls)
              search_handler_calls = 0;
              return false;
          }
          $(".preloader-wrapper").addClass("active");
          $(".searchBtn i").addClass("hide");
          $(".searchBtn").addClass("disabled");
          $(".preloader-wrapper").removeClass("hide");
          var locationValue = $(".searchBox").val();
          $.ajax({
              //url:"http://nominatim.openstreetmap.org/search/"+ locationValue +"?format=json&addressdetails=1&limit=1&polygon_svg=1",
              url:"http://photon.komoot.de/api/?q="+locationValue+"&limit=10",
              type:"GET",
              cache: false,
              error: function() {
                  alert("an error occured");
              },
              success: function(response){
                  if(response!='error'){
                      //console.log("hello");
                      //var data = JSON.parse(response);
                      // console.log(response);
                      // console.log(locationValue)

                      var dataObj = {};
                      for(var i in response["features"]){
                          var locationName = response["features"][i]["properties"]["name"];
                          dataObj[locationName] = null;
                      }

                      autoComplete(dataObj);

                      // if(!!Object.keys(dataObj)){
                      //   searchQuery(Object.keys(dataObj)[0]);
                      // }
                  }
              }
          });
      }
  });

  function initiate_search_loader(){
    $(".preloader-wrapper").addClass("active");
    $(".searchBtn i").addClass("hide");
    $(".searchBtn").addClass("disabled");
    $(".preloader-wrapper").removeClass("hide");
  }

  function remove_search_loader(){
    $(".preloader-wrapper").removeClass("active");
    $(".searchBtn i").removeClass("hide");
    $(".searchBtn").removeClass("disabled");
    $(".preloader-wrapper").addClass("hide");
  }

  function current_location(){
    var currentLat, currentLong;
    navigator.geolocation.getCurrentPosition(function(location) {
      lat = currentLat = location.coords.latitude;
      long_ = currentLong = location.coords.longitude;
      map.setView(new L.LatLng(currentLat, currentLong), 15);
      remove_search_loader();
    });
  }

  $("#current_location_btn").on("click", function(){
    initiate_search_loader();
    current_location();
  });


  function show_info(){
    if(!!lat && !!long_ ){
      $("#latinfo").html(lat.toFixed(2));
      $("#longinfo").html(long_.toFixed(2));
    }

    $("#loc_info").css('display', 'block');
  }

  $("#cornerbtn").click(show_info);

  $('#upload').change(function (evt){
      var files = evt.target.files; // FileList objec

      // Loop through the FileList and render image files as thumbnails.
      for (var i = 0, f; f = files[i]; i++) {

        // Only process image files.
        if (!f.type.match('image.*')) {
          continue;
        }

        var reader = new FileReader();

        // Closure to capture the file information.
        reader.onload = (function(theFile) {
          return function(e) {
            // Render thumbnail.
            // var span = document.createElement('span');
            // console.log(e.target.result);
            data = e.target.result;
          }
        })(f);
       
        // Read in the image file as a data URL.
        reader.readAsDataURL(f);
        var image = f;

        EXIF.getData(image, function() {
          // console.log(image.target.files[0]);
          // image = evt.target.files[0];
          name = image["name"];
          var metaData = EXIF.getAllTags(this);
          // console.log(metaData);
          // console.log(Object.keys(metaData).length);
          // var lat, long;
          // console.log(metaData);
          if(metaData && Object.keys(metaData).length != 0 && metaData.GPSLatitude && metaData.GPSLongitude && metaData.GPSLatitudeRef && metaData.GPSLongitudeRef){
            // console.log(lat);
            // console.log(long_);
            if(!!lat && !!long_){
                var r = confirm("The image is geotagged. Continue with this location?");
                if(r){
                  lat = metaData.GPSLatitude; long_ = metaData.GPSLongitude;
                  lat = lat[0]["numerator"]/lat[0]["denominator"] + lat[1]["numerator"]/(60.0*lat[1]["denominator"]) + lat[2]["numerator"]/(3600.0*lat[2]["denominator"]) ;
                  long_ = long_[0]["numerator"]/long_[0]["denominator"] + long_[1]["numerator"]/(60.0*long_[1]["denominator"]) + long_[2]["numerator"]/(3600.0*long_[2]["denominator"]) ;
                  if (lat == null || long_ == null) return;
                  if(metaData.GPSLatitudeRef == "S")lat = -lat;
                  if(metaData.GPSLongitudeRef == "W")long_ = -long_;
                  if(onClickMarker != ""){
                    map.removeLayer(onClickMarker);
                  }
                  onClickMarker = L.marker([lat, long_]).addTo(map);
                }
              $("#latinfo").html(lat.toFixed(2));
              $("#longinfo").html(long_.toFixed(2));
            }
          }
          else{
            if(!lat || !long_){
              alert("Select a location first!");
              return;
            }
          }
        });
      }
    });

  // $("#tag").tokenInput(tagSet, {
  //       theme: "facebook"
  //   });
    $(document).keyup(function(e) {
      if (e.keyCode == 27) { 
        $("#loc_info").css("display","none"); 
        document.getElementById("upload").value = "";
        document.getElementById("upload_text").value = "";
        document.getElementById("tag").value = "";
        document.getElementById("autocomplete-input").value = "";
        $('.token-input-list-facebook').html('');
        
        if(onClickMarker != ""){
          map.removeLayer(onClickMarker);
        }
      }
    });
    $("#delete_pic").click(function() {
            var hashToDelete = getHashFromUrl($(this).prev().prev().attr("src"));
            console.log("Deleting... "+hashToDelete);

            SimpleStorage.deleteImage(hashToDelete).then(function () {
              // REMOVE THIS FROM myImages 
              for (i = 0; i < myImages.length; i++){
                  if(myImages[i].url.indexOf(hashToDelete) !== -1)
                    break;
              }
              if(i < myImages.length){
                myImages.splice(i, 1);
              }

            // Refresh Image DB
            delete allPhotos;
            allPhotos = [];

            var str = SimpleStorage.GetImages();
            // console.log(str);
            str.then(function(result) {
              var arr = result.toString().split("\n");
              allPhotos = [];
              for (i = 0; i < arr.length - 1 ; i++){
                   var temp = arr[i].split(";");
                   allPhotos[i] = {"url":getUrlFromHash(temp[0]), "lat":temp[1], "lng":temp[2], "caption":temp[3], "video":"", "thumbnail":getUrlFromHash(temp[0])};
               }
              // console.log(allPhotos); 
              refreshLayer();

              trigger_stripe();
            });
            // for (i = 0; i < allPhotos.length; i++){
            //       if(allPhotos[i].url.indexOf(hashToDelete) !== -1)
            //         break;
            // }
            // if(i < allPhotos.length){
            //   allPhotos.splice(i, 1);
            // }
            });
  });
          
    console.log("Zsafasfoomed image on the wasagadsgsdgdsgy");    
  //   $(".leaflet-popup-content").click(function() {
  //         console.log("Zoomed image on the way");

          // $("#photo_stripe").html('');
          // $('#viewer').attr('src', '');
          // $('#photoViewer .card-title').css('display', 'none');
          // $('#photoViewer a').css('display', 'none');
          
          // if (myImages.length == 0 || (myImages.length==1 && !myImages[0].lat)){
          //   $('#photoViewer .card-content').html('<p>You do not have any personal images to show.</p>');
          // }
          // else {
          //   for (i = 0; i < myImages.length; i++){
          //     if(myImages[i].lat){
          //       $("#photo_stripe").append('<img class="photo_box" src="'+myImages[i].url+'" caption="'+myImages[i].caption+'">');
          //     }
          //   }
          //   $('#photoViewer .card-content').html('<p>Please click on any of the below images to start exploring!</p>');
          // }

  // });
  
});

  </script>
</body>
</html>
